<!-- Modal de generación masiva de facturas -->
<app-reusable-modal
  [isOpen]="isOpen"
  [title]="'Generación Masiva de Facturas'"
  [subtitle]="'Revisa y edita los números de factura y fechas de emisión antes de generar las facturas'"
  [submitText]="'Generar Facturas'"
  [isFormValid]="true"
  [showFormStatus]="false"
  [actionType]="'create'"
  (onSubmit)="onSubmit()"
  (onCancel)="onCancel()">

  <!-- Contenido del modal -->
  <div class="px-6 py-4">
    <!-- Mensaje de error -->
    @if (errorMessage) {
    <div class="mb-4 p-4 bg-red-50 border border-red-200 rounded-lg flex items-start gap-3">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
        class="h-5 w-5 text-red-600 flex-shrink-0 mt-0.5">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" x2="12" y1="8" y2="12"></line>
        <line x1="12" x2="12.01" y1="16" y2="16"></line>
      </svg>
      <div class="flex-1">
        <p class="text-sm font-medium text-red-800">{{ errorMessage }}</p>
      </div>
      <button type="button" (click)="onCloseError()" class="text-red-600 hover:text-red-800 transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5">
          <path d="M18 6 6 18"></path>
          <path d="m6 6 12 12"></path>
        </svg>
      </button>
    </div>
    }

    <div class="min-w-[800px]">
      <div data-slot="table-container" class="relative w-full overflow-x-auto">
        <table data-slot="table" class="w-full caption-bottom text-sm">
          <thead data-slot="table-header" class="[&_tr]:border-b">
            <tr data-slot="table-row" class="hover:bg-muted/50 border-b transition-colors">
              <th data-slot="table-head"
                class="text-foreground h-10 px-2 text-left align-middle font-medium whitespace-nowrap min-w-[150px]">
                Paciente</th>
              <th data-slot="table-head"
                class="text-foreground h-10 px-2 text-left align-middle font-medium whitespace-nowrap min-w-[100px]">DNI
              </th>
              <th data-slot="table-head"
                class="text-foreground h-10 px-2 text-left align-middle font-medium whitespace-nowrap min-w-[80px]">
                Sesiones</th>
              <th data-slot="table-head"
                class="text-foreground h-10 px-2 text-left align-middle font-medium whitespace-nowrap min-w-[80px]">
                Total</th>
              <th data-slot="table-head"
                class="text-foreground h-10 px-2 text-left align-middle font-medium whitespace-nowrap min-w-[180px]">
                Número de Factura</th>
              <th data-slot="table-head"
                class="text-foreground h-10 px-2 text-left align-middle font-medium whitespace-nowrap min-w-[150px]">
                Fecha de Emisión</th>
              <th data-slot="table-head"
                class="text-foreground h-10 px-2 text-left align-middle font-medium whitespace-nowrap min-w-[80px]">
                Acciones</th>
            </tr>
          </thead>
          <tbody data-slot="table-body" class="[&_tr:last-child]:border-0">
            @for (invoice of invoicesToGenerate; track invoice.dni) {
            <tr data-slot="table-row" class="hover:bg-muted/50 border-b transition-colors">
              <td data-slot="table-cell" class="p-2 align-middle whitespace-nowrap font-medium">{{
                invoice.patient_full_name }}</td>
              <td data-slot="table-cell" class="p-2 align-middle whitespace-nowrap">{{ invoice.dni }}</td>
              <td data-slot="table-cell" class="p-2 align-middle whitespace-nowrap">
                <span data-slot="badge"
                  class="inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap text-foreground">
                  {{ invoice.pending_sessions_count }}
                </span>
              </td>
              <td data-slot="table-cell" class="p-2 align-middle whitespace-nowrap font-semibold">{{
                formatCurrency(invoice.total_gross) }}</td>
              <td data-slot="table-cell" class="p-2 align-middle whitespace-nowrap">
                <input data-slot="input" type="text" [value]="invoice.invoice_number" disabled readonly
                  class="border-input h-9 w-full min-w-[160px] rounded-md border bg-gray-50 px-3 py-1 text-base shadow-xs outline-none md:text-sm cursor-not-allowed text-gray-600">
              </td>
              <td data-slot="table-cell" class="p-2 align-middle whitespace-nowrap">
                <input data-slot="input" type="date" [value]="invoice.invoice_date"
                  (input)="onDateChange(invoice.dni, $event)"
                  class="border-input h-9 w-full min-w-[140px] rounded-md border bg-background px-3 py-1 text-base shadow-xs transition-[color,box-shadow] outline-none md:text-sm focus-visible:ring-[3px]">
              </td>
              <td data-slot="table-cell" class="p-2 align-middle whitespace-nowrap">
                <button data-slot="button" type="button" (click)="onPreview(invoice.dni)"
                  class="inline-flex items-center justify-center whitespace-nowrap text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground h-8 rounded-md gap-1.5 px-3">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="h-4 w-4">
                    <path
                      d="M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0">
                    </path>
                    <circle cx="12" cy="12" r="3"></circle>
                  </svg>
                </button>
              </td>
            </tr>
            }
          </tbody>
        </table>
      </div>
    </div>

    <!-- Summary footer -->
    <div class="flex justify-between items-center mt-4 pt-4 border-t bg-muted/30 px-4 py-3 rounded-lg">
      <div class="text-sm text-muted-foreground">
        {{ invoicesToGenerate.length }} {{ invoicesToGenerate.length === 1 ? 'factura' : 'facturas' }} •
        Total: {{ formatCurrency(totalSelectedAmount) }}
      </div>
    </div>
  </div>

</app-reusable-modal>
