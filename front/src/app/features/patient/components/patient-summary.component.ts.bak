import {
  Component,
  ChangeDetectionStrategy,
  Input,
  signal,
  computed
} from '@angular/core';
import { CommonModule } from '@angular/common';
import { Patient } from '../../../shared/models/patient.model';
import { Session, Invoice, Bonus } from '../../../shared/models/mock-data.model';

/**
 * Patient Summary Component
 *
 * Displays summary information for a patient including:
 * - Basic patient data
 * - Session statistics
 * - Session history
 * - Billing information
 */
@Component({
  selector: 'app-patient-summary',
  standalone: true,
  imports: [CommonModule],
  templateUrl: './patient-summary.component.html',
  changeDetection: ChangeDetectionStrategy.OnPush,
})
export class PatientSummaryComponent {
  @Input() patient!: Patient;
  @Input() sessions: Session[] = [];
  @Input() invoices: Invoice[] = [];
  @Input() bonuses: Bonus[] = [];

  readonly selectedYear = signal("2024");
  readonly dateRange = signal("all");

  readonly currentYear = new Date().getFullYear();
  readonly years = Array.from({ length: 3 }, (_, i) => (this.currentYear - i).toString());

  readonly filteredSessions = computed(() => {
    return this.sessions.filter(session =>
      session.date.getFullYear().toString() === this.selectedYear()
    );
  });

  readonly completedSessions = computed(() =>
    this.filteredSessions().filter(s => s.status === "completed").length
  );

  readonly scheduledSessions = computed(() =>
    this.filteredSessions().filter(s => s.status === "scheduled").length
  );

  readonly cancelledSessions = computed(() =>
    this.filteredSessions().filter(s => s.status === "cancelled").length
  );

  readonly totalSpent = computed(() =>
    this.filteredSessions()
      .filter(s => s.status === "completed")
      .reduce((sum, s) => sum + s.price, 0)
  );

  readonly recentSessions = computed(() => this.sessions.slice(0, 10));

  onYearChange(year: string): void {
    this.selectedYear.set(year);
  }

  onDateRangeChange(range: string): void {
    this.dateRange.set(range);
  }

  formatPaymentMethod(method: string): string {
    const methods: Record<string, string> = {
      'cash': 'Efectivo',
      'card': 'Tarjeta',
      'transfer': 'Transferencia',
      'bizum': 'Bizum'
    };
    return methods[method] || method;
  }

  getFullName(patient: Patient): string {
    return `${patient.first_name} ${patient.last_name}`;
  }

  formatDate(date: Date): string {
    return date.toLocaleDateString("es-ES");
  }
}