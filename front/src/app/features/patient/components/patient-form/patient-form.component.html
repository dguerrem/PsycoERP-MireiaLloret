<app-reusable-modal [isOpen]="isOpen" [title]="title" [subtitle]="'Completa todos los campos requeridos'"
  [submitText]="submitButtonText" [isFormValid]="isFormValid" [actionType]="isEditing ? 'edit' : 'create'"
  (onSubmit)="handleSubmit()" (onCancel)="handleCancel()">

  <!-- Todo el contenido del formulario va aquí -->
  <form id="patient-form" [formGroup]="patientForm" (ngSubmit)="handleSubmit()" class="p-4 sm:p-6 space-y-6">

    <!-- Información Personal Básica -->
    <section class="space-y-4">
      <div class="flex items-center gap-3 pb-3 border-b border-gray-100">
        <div class="p-1.5 bg-blue-100 rounded-md">
          <svg class="h-4 w-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg>
        </div>
        <h3 class="text-lg font-semibold text-gray-900">Información Personal</h3>
      </div>

      <!-- Campos agrupados lógicamente -->
      <div class="space-y-4">
        <!-- Nombre completo y DNI -->
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
          <app-form-input controlName="first_name" label="Nombre" placeholder="Ej: Juan" [required]="true">
          </app-form-input>

          <app-form-input controlName="last_name" label="Apellidos" placeholder="Ej: Pérez García" [required]="true">
          </app-form-input>

          <app-form-input controlName="dni" label="DNI" placeholder="Ej: 12345678A" [required]="true">
          </app-form-input>

          <app-form-input controlName="occupation" label="Escuela/Trabajo"
            placeholder="Ej: Estudiante, Ingeniero, Médico, etc." [required]="true">
          </app-form-input>
        </div>

        <!-- Datos demográficos -->
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
          <app-form-input controlName="birth_date" label="Fecha de nacimiento" type="date" [required]="true"
            (onChange)="onBirthDateChange()">
          </app-form-input>

          <app-form-input controlName="gender" label="Género" type="select" [options]="genderOptions"
            selectPlaceholder="Seleccionar género..." [required]="true">
          </app-form-input>

          <!-- Indicador de edad -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Estado de Edad
            </label>
            <div class="flex items-center h-10 px-3 py-2 text-sm bg-gray-50 rounded-lg border border-gray-200">
              <div class="flex items-center gap-2">
                @if (patientForm.get('is_minor')?.value) {
                <div class="w-2 h-2 bg-amber-500 rounded-full"></div>
                <span class="text-amber-700 font-medium">Menor de edad</span>
                } @else {
                <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                <span class="text-green-700 font-medium">Mayor de edad</span>
                }
                @if (patientForm.get('birth_date')?.value) {
                <span class="text-gray-500">({{ getCalculatedAge() }} años)</span>
                }
              </div>
            </div>
          </div>

          <!-- Campo adicional para completar las 4 columnas -->
          <div class="hidden md:block"></div>
        </div>
      </div>
    </section>

    <!-- Información de Contacto -->
    <section class="space-y-4">
      <div class="flex items-center gap-3 pb-3 border-b border-gray-100">
        <div class="p-1.5 bg-green-100 rounded-md">
          <svg class="h-4 w-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
          </svg>
        </div>
        <h3 class="text-lg font-semibold text-gray-900">Información de Contacto</h3>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
        <app-form-input controlName="email" label="Email" placeholder="Ej: juan.perez@email.com" type="email"
          [required]="true">
        </app-form-input>

        <app-form-input controlName="phone" label="Teléfono" placeholder="Ej: +34 666 123 456" type="tel"
          [required]="true">
        </app-form-input>
      </div>
    </section>

    <!-- Dirección -->
    <section class="space-y-4">
      <div class="flex items-center gap-3 pb-3 border-b border-gray-100">
        <div class="p-1.5 bg-purple-100 rounded-md">
          <svg class="h-4 w-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
        </div>
        <h3 class="text-lg font-semibold text-gray-900">Dirección</h3>
      </div>

      <div class="space-y-4">
        <!-- Primera fila de dirección -->
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
          <app-form-input controlName="street" label="Calle" placeholder="Ej: Calle Mayor" [required]="true">
          </app-form-input>

          <app-form-input controlName="street_number" label="Número" placeholder="123" [required]="true">
          </app-form-input>

          <app-form-input controlName="door" label="Puerta" placeholder="2º A">
          </app-form-input>

          <app-form-input controlName="postal_code" label="Código Postal" placeholder="28001" [required]="true">
          </app-form-input>
        </div>

        <!-- Segunda fila de dirección -->
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
          <app-form-input controlName="city" label="Ciudad" placeholder="Madrid" [required]="true">
          </app-form-input>

          <app-form-input controlName="province" label="Provincia" placeholder="Madrid" [required]="true">
          </app-form-input>

          <!-- Campos vacíos para completar las 4 columnas -->
          <div class="hidden md:block"></div>
          <div class="hidden md:block"></div>
        </div>
      </div>
    </section>

    <!-- Información del Tratamiento -->
    <section class="space-y-4">
      <div class="flex items-center gap-3 pb-3 border-b border-gray-100">
        <div class="p-1.5 bg-orange-100 rounded-md">
          <svg class="h-4 w-4 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
        </div>
        <h3 class="text-lg font-semibold text-gray-900">Información del Tratamiento</h3>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">

        <app-form-input controlName="treatment_start_date" label="Fecha Inicio Tratamiento" type="date"
          [required]="true">
        </app-form-input>

        <app-form-input controlName="status" label="Estado del Tratamiento" type="select" [options]="statusOptions"
          [required]="true">
        </app-form-input>
        <!-- Clinic Selector -->
        <app-clinic-selector [control]="$any(patientForm.get('clinic_id'))" [clinics]="clinics" [required]="true"
          [disabled]="isEditing" label="Clínica" placeholder="Buscar clínica...">
        </app-clinic-selector>
      </div>
    </section>
  </form>
</app-reusable-modal>
