<!-- Modal Backdrop -->
<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" 
     (click)="onBackdropClick($event)">
  
  <!-- Modal Content - Exact match to React -->
  <div class="bg-background rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto" 
       (click)="$event.stopPropagation()">
    
    <!-- Header - Exact match to React -->
    <div class="flex items-center justify-between p-6 border-b border-border">
      <h2 class="text-xl font-semibold">Nueva Cita</h2>
      <button 
        type="button"
        (click)="onClose()"
        class="inline-flex items-center justify-center whitespace-nowrap text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50 h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x h-4 w-4">
          <path d="M18 6 6 18"></path>
          <path d="m6 6 12 12"></path>
        </svg>
      </button>
    </div>

    <!-- Form Content - Reactive Forms -->
    <form [formGroup]="sessionForm" (ngSubmit)="onSubmit()" class="p-6 space-y-6">
      
      <!-- Error Message -->
      @if (error()) {
        <div class="mb-4 p-4 bg-red-50 border border-red-200 rounded-md">
          <p class="text-sm text-red-600">{{ error() }}</p>
        </div>
      }

      <!-- Patient Selection - Custom Dropdown -->
      <div class="space-y-2">
        <label class="text-sm leading-none font-medium select-none group-data-[disabled=true]:pointer-events-none group-data-[disabled=true]:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:opacity-50 flex items-center gap-2" for="patient">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user h-4 w-4">
            <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
          </svg>
          Paciente
        </label>
        <div class="relative">
          <button 
            type="button" 
            (click)="toggleDropdown('patient')"
            class="flex w-full items-center justify-between gap-2 rounded-md border-2 border-gray-300 bg-white px-3 py-2 text-sm shadow-sm transition-colors hover:border-gray-400 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20 disabled:cursor-not-allowed disabled:opacity-50 h-10">
            <span class="line-clamp-1 flex items-center gap-2">{{ getDisplayValue('patient') }}</span>
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down size-4 opacity-50" aria-hidden="true">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </button>
          @if (dropdownStates().patient) {
            <div class="absolute z-50 w-full mt-1 bg-white border border-gray-200 rounded-md shadow-lg max-h-60 overflow-auto">
              @for (patient of patients; track patient.id) {
                <div 
                  (click)="selectOption('patient', patient.id.toString())"
                  class="px-3 py-2 cursor-pointer text-sm transition-colors hover:text-white"
                  onmouseover="this.style.backgroundColor='#0891b2'; this.style.color='white'"
                  onmouseout="this.style.backgroundColor=''; this.style.color=''">
                  {{ patient.name }}
                </div>
              }
            </div>
          }
        </div>
      </div>

      <!-- Date and Time Grid - Exact match to React -->
      <div class="grid grid-cols-2 gap-4">
        <!-- Date -->
        <div class="space-y-2">
          <label class="text-sm leading-none font-medium select-none group-data-[disabled=true]:pointer-events-none group-data-[disabled=true]:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:opacity-50 flex items-center gap-2" for="date">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar h-4 w-4">
              <path d="M8 2v4"></path>
              <path d="M16 2v4"></path>
              <rect width="18" height="18" x="3" y="4" rx="2"></rect>
              <path d="M3 10h18"></path>
            </svg>
            Fecha
          </label>
          <input 
            type="date"
            id="date"
            formControlName="session_date"
            class="flex h-10 w-full rounded-md border-2 border-gray-300 bg-white px-3 py-2 text-sm shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-gray-500 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20 disabled:cursor-not-allowed disabled:opacity-50">
        </div>

        <!-- Time -->
        <div class="space-y-2">
          <label class="text-sm leading-none font-medium select-none group-data-[disabled=true]:pointer-events-none group-data-[disabled=true]:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:opacity-50 flex items-center gap-2" for="time">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clock h-4 w-4">
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            Hora
          </label>
          <input 
            type="time"
            id="time"
            formControlName="start_time"
            (change)="onStartTimeChange()"
            class="flex h-10 w-full rounded-md border-2 border-gray-300 bg-white px-3 py-2 text-sm shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-gray-500 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20 disabled:cursor-not-allowed disabled:opacity-50">
        </div>
      </div>

      <!-- Clinic and Type Grid - Exact match to React -->
      <div class="grid grid-cols-2 gap-4">
        <!-- Clinic -->
        <div class="space-y-2">
          <label class="text-sm leading-none font-medium select-none group-data-[disabled=true]:pointer-events-none group-data-[disabled=true]:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:opacity-50 flex items-center gap-2" for="clinic">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-map-pin h-4 w-4">
              <path d="M20 10c0 4.993-5.539 10.193-7.399 11.799a1 1 0 0 1-1.202 0C9.539 20.193 4 14.993 4 10a8 8 0 0 1 16 0"></path>
              <circle cx="12" cy="10" r="3"></circle>
            </svg>
            Clínica
          </label>
          <div class="relative">
            <button 
              type="button" 
              (click)="toggleDropdown('clinic')"
              class="flex w-full items-center justify-between gap-2 rounded-md border-2 border-gray-300 bg-white px-3 py-2 text-sm shadow-sm transition-colors hover:border-gray-400 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20 disabled:cursor-not-allowed disabled:opacity-50 h-10">
              <span class="line-clamp-1 flex items-center gap-2">{{ getDisplayValue('clinic') }}</span>
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down size-4 opacity-50" aria-hidden="true">
                <path d="m6 9 6 6 6-6"></path>
              </svg>
            </button>
            @if (dropdownStates().clinic) {
              <div class="absolute z-50 w-full mt-1 bg-white border border-gray-200 rounded-md shadow-lg max-h-60 overflow-auto">
                @for (clinic of clinicConfigs; track clinic.id) {
                  <div 
                    (click)="selectOption('clinic', clinic.id.toString())"
                    class="px-3 py-2 cursor-pointer text-sm transition-colors hover:text-white"
                    onmouseover="this.style.backgroundColor='#0891b2'; this.style.color='white'"
                    onmouseout="this.style.backgroundColor=''; this.style.color=''">
                    {{ clinic.name }}
                  </div>
                }
              </div>
            }
          </div>
        </div>

        <!-- Session Type -->
        <div class="space-y-2">
          <label class="flex items-center gap-2 text-sm leading-none font-medium select-none group-data-[disabled=true]:pointer-events-none group-data-[disabled=true]:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:opacity-50" for="type">
            Tipo de Sesión
          </label>
          <div class="relative">
            <button 
              type="button" 
              (click)="toggleDropdown('type')"
              class="flex w-full items-center justify-between gap-2 rounded-md border-2 border-gray-300 bg-white px-3 py-2 text-sm shadow-sm transition-colors hover:border-gray-400 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20 disabled:cursor-not-allowed disabled:opacity-50 h-10">
              <span class="line-clamp-1 flex items-center gap-2">{{ getDisplayValue('type') }}</span>
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down size-4 opacity-50" aria-hidden="true">
                <path d="m6 9 6 6 6-6"></path>
              </svg>
            </button>
            @if (dropdownStates().type) {
              <div class="absolute z-50 w-full mt-1 bg-white border border-gray-200 rounded-md shadow-lg max-h-60 overflow-auto">
                @for (type of sessionTypes; track type) {
                  <div 
                    (click)="selectOption('type', type)"
                    class="px-3 py-2 cursor-pointer text-sm transition-colors hover:text-white"
                    onmouseover="this.style.backgroundColor='#0891b2'; this.style.color='white'"
                    onmouseout="this.style.backgroundColor=''; this.style.color=''">
                    {{ type }}
                  </div>
                }
              </div>
            }
          </div>
        </div>
      </div>

      <!-- Price and Payment Grid - Exact match to React -->
      <div class="grid grid-cols-2 gap-4">
        <!-- Price -->
        <div class="space-y-2">
          <label class="text-sm leading-none font-medium select-none group-data-[disabled=true]:pointer-events-none group-data-[disabled=true]:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:opacity-50 flex items-center gap-2" for="price">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-credit-card h-4 w-4">
              <rect width="20" height="14" x="2" y="5" rx="2"></rect>
              <line x1="2" x2="22" y1="10" y2="10"></line>
            </svg>
            Precio (€)
          </label>
          <input 
            type="number"
            id="price"
            formControlName="price"
            step="0.01"
            placeholder="0.00"
            class="flex h-10 w-full rounded-md border-2 border-gray-300 bg-white px-3 py-2 text-sm shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-gray-500 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20 disabled:cursor-not-allowed disabled:opacity-50">
        </div>

        <!-- Payment Method -->
        <div class="space-y-2">
          <label class="flex items-center gap-2 text-sm leading-none font-medium select-none group-data-[disabled=true]:pointer-events-none group-data-[disabled=true]:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:opacity-50" for="payment">
            Método de Pago
          </label>
          <div class="relative">
            <button 
              type="button" 
              (click)="toggleDropdown('payment')"
              class="flex w-full items-center justify-between gap-2 rounded-md border-2 border-gray-300 bg-white px-3 py-2 text-sm shadow-sm transition-colors hover:border-gray-400 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20 disabled:cursor-not-allowed disabled:opacity-50 h-10">
              <span class="line-clamp-1 flex items-center gap-2">{{ getDisplayValue('payment') }}</span>
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down size-4 opacity-50" aria-hidden="true">
                <path d="m6 9 6 6 6-6"></path>
              </svg>
            </button>
            @if (dropdownStates().payment) {
              <div class="absolute z-50 w-full mt-1 bg-white border border-gray-200 rounded-md shadow-lg max-h-60 overflow-auto">
                @for (method of paymentMethods; track method) {
                  <div 
                    (click)="selectOption('payment', method)"
                    class="px-3 py-2 cursor-pointer text-sm transition-colors hover:text-white"
                    onmouseover="this.style.backgroundColor='#0891b2'; this.style.color='white'"
                    onmouseout="this.style.backgroundColor=''; this.style.color=''">
                    {{ getPaymentMethodText(method) }}
                  </div>
                }
              </div>
            }
          </div>
        </div>
      </div>

      <!-- Modality - Custom Dropdown -->
      <div class="space-y-2">
        <label class="flex items-center gap-2 text-sm leading-none font-medium select-none group-data-[disabled=true]:pointer-events-none group-data-[disabled=true]:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:opacity-50" for="modality">
          Modalidad
        </label>
        <div class="relative">
          <button 
            type="button" 
            (click)="toggleDropdown('modality')"
            class="flex w-full items-center justify-between gap-2 rounded-md border-2 border-gray-300 bg-white px-3 py-2 text-sm shadow-sm transition-colors hover:border-gray-400 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20 disabled:cursor-not-allowed disabled:opacity-50 h-10">
            <span class="line-clamp-1 flex items-center gap-2">{{ getDisplayValue('modality') }}</span>
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down size-4 opacity-50" aria-hidden="true">
              <path d="m6 9 6 6 6-6"></path>
            </svg>
          </button>
          @if (dropdownStates().modality) {
            <div class="absolute z-50 w-full mt-1 bg-white border border-gray-200 rounded-md shadow-lg max-h-60 overflow-auto">
              @for (mode of sessionModes; track mode) {
                <div 
                  (click)="selectOption('modality', mode)"
                  class="px-3 py-2 cursor-pointer text-sm transition-colors hover:text-white"
                  onmouseover="this.style.backgroundColor='#0891b2'; this.style.color='white'"
                  onmouseout="this.style.backgroundColor=''; this.style.color=''">
                  {{ mode }}
                </div>
              }
            </div>
          }
        </div>
      </div>

      <!-- Notes - Exact match to React -->
      <div class="space-y-2">
        <label class="flex items-center gap-2 text-sm leading-none font-medium select-none group-data-[disabled=true]:pointer-events-none group-data-[disabled=true]:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:opacity-50" for="notes">
          Notas
        </label>
        <textarea 
          id="notes"
          formControlName="notes"
          placeholder="Notas adicionales sobre la cita..."
          rows="3"
          class="flex min-h-16 w-full rounded-md border-2 border-gray-300 bg-white px-3 py-2 text-sm shadow-sm transition-colors placeholder:text-gray-500 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20 disabled:cursor-not-allowed disabled:opacity-50">
        </textarea>
      </div>

      <!-- Buttons - Exact match to React -->
      <div class="flex justify-end gap-3 pt-4">
        <button 
          type="button"
          (click)="onClose()"
          [disabled]="isLoading()"
          class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 border bg-white border-gray-300 hover:text-white shadow-sm h-9 px-4 py-2"
          onmouseover="this.style.backgroundColor='#0891b2'; this.style.borderColor='#0891b2'"
          onmouseout="this.style.backgroundColor=''; this.style.borderColor='#d1d5db'">
          Cancelar
        </button>
        <button 
          type="submit"
          [disabled]="isLoading()"
          class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive text-primary-foreground shadow-xs h-9 px-4 py-2 has-[>svg]:px-3 bg-primary hover:bg-primary/90">
          @if (isLoading()) {
            <svg class="animate-spin -ml-1 mr-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Creando...
          } @else {
            Crear Cita
          }
        </button>
      </div>
    </form>

  </div>
</div>