<div class="p-4 sm:p-6 h-screen overflow-hidden">
  <div class="w-full h-full flex flex-col max-h-full">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-4 sm:mb-6">
      <div>
        <h1 class="text-2xl sm:text-3xl font-black font-montserrat text-gray-900">Calendario</h1>
        <p class="text-sm sm:text-base text-gray-600 mt-1 sm:mt-2">
          Gestión de citas y horarios por clínica
        </p>
      </div>
      <div class="flex items-center gap-4">
        <button (click)="onNewSessionClick()"
          class="bg-primary hover:opacity-90 w-full sm:w-auto inline-flex items-center justify-center px-4 py-2 text-white rounded-md transition-opacity font-medium">
          <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
          </svg>
          Nueva Cita
        </button>
      </div>
    </div>

    <!-- Controls -->
    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-4 sm:mb-6">
      <div class="flex flex-col sm:flex-row sm:items-center gap-4">
        <!-- Navegación de fechas -->
        <div class="flex items-center gap-2">
          <button (click)="navigatePrevious()"
            class="border border-gray-300 bg-white hover:bg-primary hover:border-primary hover:text-white inline-flex items-center justify-center rounded-xl px-3 py-2 text-sm font-medium transition-all">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
          </button>
          <h2 class="text-base sm:text-lg font-semibold min-w-[180px] sm:min-w-[200px] text-center text-gray-900">
            @if (currentView() === 'week') {
            {{ formatWeekRange(weekDates()) }}
            } @else {
            {{ formatMonthYear(currentDate()) }}
            }
          </h2>
          <button (click)="navigateNext()"
            class="border border-gray-300 bg-white hover:bg-primary hover:border-primary hover:text-white inline-flex items-center justify-center rounded-xl px-3 py-2 text-sm font-medium transition-all">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
          </button>
        </div>

        <!-- Toggle Semana/Mes -->
        <div class="flex rounded-lg border border-gray-300 overflow-hidden">
          <button (click)="setView('week')"
            [class]="currentView() === 'week' ? 'text-white' : 'bg-white hover:bg-gray-50 text-gray-700'"
            [style.background-color]="currentView() === 'week' ? '#0891b2' : ''"
            class="rounded-none flex-1 sm:flex-none inline-flex items-center justify-center px-3 py-2 text-sm font-medium transition-colors">
            Semana
          </button>
          <button (click)="setView('month')"
            [class]="currentView() === 'month' ? 'text-white' : 'bg-white hover:bg-gray-50 text-gray-700'"
            [style.background-color]="currentView() === 'month' ? '#0891b2' : ''"
            class="rounded-none flex-1 sm:flex-none inline-flex items-center justify-center px-3 py-2 text-sm font-medium transition-colors">
            Mes
          </button>
        </div>
      </div>

      <!-- Leyenda de clínicas -->
      <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4">
        <span class="text-sm font-medium text-gray-600">Clínicas:</span>
        <div class="grid grid-cols-2 sm:flex sm:items-center gap-2 sm:gap-4">
          @for (config of clinicConfigs; track config.id) {
          <div class="flex items-center gap-2">
            <div [class]="config.backgroundColor" class="w-3 h-3 rounded-full flex-shrink-0"></div>
            <span class="text-xs sm:text-sm truncate text-gray-700">{{ config.name }}</span>
          </div>
          }
        </div>
      </div>
    </div>

    <!-- Calendar Grid -->
    <div class="bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm flex-1 flex flex-col min-h-0">

      <!-- Week View -->
      @if (currentView() === 'week') {
      <div class="h-full overflow-auto">
        <div class="min-w-[640px] sm:min-w-full h-full">
          <div class="grid grid-cols-8 h-full">
            <!-- Columna de horas STICKY -->
            <div class="border-r border-gray-200 bg-white sticky left-0 z-20">
              <div
                class="h-10 sm:h-12 border-b border-gray-200 flex items-center justify-center bg-gray-50 sticky top-0 z-30">
                <span class="text-xs sm:text-sm font-medium text-gray-700">Hora</span>
              </div>
              <!-- Slots de tiempo -->
              @for (hour of hours; track hour) {
              <div
                class="h-16 sm:h-20 border-b border-gray-200 flex items-center justify-center bg-gray-50 text-xs sm:text-sm font-medium text-gray-600">
                {{ hour }}
              </div>
              }
            </div>

            <!-- Columnas de días -->
            @for (date of weekDates(); track date.getTime()) {
            <div class="border-r border-gray-200 last:border-r-0 min-w-[80px] sm:min-w-[120px]">
              <!-- Header día STICKY -->
              <div
                class="h-10 sm:h-12 border-b border-gray-200 flex flex-col items-center justify-center bg-gray-50 sticky top-0 z-10 px-1">
                <div class="text-xs sm:text-sm font-medium text-gray-600">
                  <span class="sm:hidden">{{ weekDays[$index].charAt(0) }}</span>
                  <span class="hidden sm:inline">{{ weekDays[$index] }}</span>
                </div>
                <div
                  [class]="isToday(date) ? 'text-white rounded-full w-5 h-5 sm:w-6 sm:h-6 flex items-center justify-center text-xs sm:text-sm font-semibold' : 'text-gray-900 text-xs sm:text-sm font-semibold'"
                  [style.background-color]="isToday(date) ? '#0891b2' : ''">
                  {{ formatDate(date) }}
                </div>
              </div>
              <!-- Slots horarios -->
              @for (hour of hours; track hour) {
              <div class="h-16 sm:h-20 border-b border-gray-200 p-1 hover:bg-gray-50 transition-colors relative group">
                <div class="h-full overflow-y-auto overflow-x-hidden space-y-0.5">
                @for (sessionData of getSortedSessionDataForDateAndHour(date, hour); track
                sessionData.SessionDetailData.session_id) {
                <div (click)="onSessionClick(sessionData)"
                  [class]="isSessionCancelled(sessionData) ?
                    'bg-gradient-to-r from-gray-50/30 to-white rounded px-1 sm:px-2 py-0.5 sm:py-1 text-xs cursor-pointer transition-all duration-200 bg-gray-200 text-gray-500 opacity-60 hover:opacity-80 relative before:absolute before:inset-0 before:bg-gray-300 before:opacity-30 before:rounded after:absolute after:top-1/2 after:left-0 after:right-0 after:h-0.5 after:bg-gray-600 after:transform after:-rotate-12 line-through' :
                    getClinicConfigFromSessionData(sessionData).backgroundColor + ' ' + getClinicConfigFromSessionData(sessionData).color + (getSessionStatusBadgeClass(sessionData).includes('green') ? ' opacity-75 border-2 border-green-500' : '') + ' rounded p-1 sm:p-2 text-xs cursor-pointer hover:opacity-90 transition-opacity'"
                  class="min-h-[40px] sm:min-h-[48px] flex flex-col justify-start relative group flex-shrink-0 p-1">
                  <!-- Indicador de completado -->
                  @if (sessionData.SessionDetailData.completed && !isSessionCancelled(sessionData)) {
                  <div
                    class="absolute -top-1 -right-1 w-3 h-3 bg-green-500 rounded-full flex items-center justify-center z-10">
                    <div class="w-1.5 h-1.5 bg-white rounded-full"></div>
                  </div>
                  }
                  <!-- Botón para nueva sesión en cancelada (solo si no hay sesión activa en el slot) -->
                  @if (isSessionCancelled(sessionData) && !hasActiveSessionInSlot(date, hour)) {
                  <button (click)="onNewSessionClickForDateTime(date, hour); $event.stopPropagation()"
                    class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-8 h-8 bg-green-500 hover:bg-green-600 rounded-full flex items-center justify-center z-20 transition-all duration-200 shadow-lg hover:shadow-xl hover:scale-110"
                    title="Crear nueva sesión">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                  </button>
                  }
                  <div class="flex flex-col space-y-0.5">
                    <div [class]="isSessionCancelled(sessionData) ? 'font-medium truncate text-xs' : 'truncate font-medium text-white text-sm'">
                      <span class="sm:hidden">{{ getPatientNameFromSessionData(sessionData).split(' ')[0] }}</span>
                      <span class="hidden sm:inline">{{ getPatientNameFromSessionData(sessionData) }}</span>
                    </div>
                    <div>
                      <span [class]="isSessionCancelled(sessionData) ? 'text-xs opacity-90' : 'text-xs text-white opacity-90'">
                        {{ formatTime(sessionData.SessionDetailData.start_time) }} - {{ formatTime(sessionData.SessionDetailData.end_time) }}
                      </span>
                    </div>
                  </div>
                </div>
                }
                </div>

                <!-- Botón "+" para crear nueva sesión cuando no hay sesiones -->
                @if (getSessionDataForDateAndHour(date, hour).length === 0) {
                <button (click)="onNewSessionClickForDateTime(date, hour)"
                  class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-200 hover:bg-blue-50 rounded"
                  title="Crear nueva sesión">
                  <svg class="w-4 h-4 text-gray-400 hover:text-blue-600 transition-colors" fill="none"
                    stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                  </svg>
                </button>
                }
              </div>
              }
            </div>
            }
          </div>
        </div>
      </div>
      }

      <!-- Month View -->
      @if (currentView() === 'month') {
      <div class="grid grid-cols-7 h-full">
        <!-- Headers de días -->
        @for (day of weekDays; track day) {
        <div class="h-8 sm:h-12 border-b border-gray-200 flex items-center justify-center bg-gray-50">
          <span class="text-xs sm:text-sm font-medium text-gray-700">
            <span class="sm:hidden">{{ day.charAt(0) }}</span>
            <span class="hidden sm:inline">{{ day }}</span>
          </span>
        </div>
        }

        <!-- Celdas de días -->
        @for (date of monthDates(); track date.getTime()) {
        <div
          [class]="'min-h-[100px] sm:min-h-[140px] border-b border-r border-gray-200 p-1 sm:p-2 group relative' + (!isCurrentMonth(date) ? ' bg-gray-50 text-gray-400' : '')"
          [style.background-color]="isToday(date) ? 'rgba(8, 145, 178, 0.05)' : ''">
          <div [class]="'text-xs sm:text-sm font-medium mb-1 sm:mb-2' + (isToday(date) ? '' : ' text-gray-900')"
            [style.color]="isToday(date) ? '#0891b2' : ''">
            {{ formatDate(date) }}
          </div>
          <div class="space-y-1 max-h-[75px] sm:max-h-[110px] overflow-y-auto overflow-x-hidden">
            @for (sessionData of getSortedSessionDataForDate(date); track sessionData.SessionDetailData.session_id) {
            <div (click)="onSessionClick(sessionData)"
              [class]="isSessionCancelled(sessionData) ?
                'bg-gradient-to-r from-gray-50/30 to-white rounded px-1 sm:px-2 py-0.5 sm:py-1 text-xs cursor-pointer transition-all duration-200 bg-gray-200 text-gray-500 opacity-60 hover:opacity-80 relative before:absolute before:inset-0 before:bg-gray-300 before:opacity-30 before:rounded after:absolute after:top-1/2 after:left-0 after:right-0 after:h-0.5 after:bg-gray-600 after:transform after:-rotate-12 line-through flex flex-col' :
                getClinicConfigFromSessionData(sessionData).backgroundColor + ' ' + getClinicConfigFromSessionData(sessionData).color + (getSessionStatusBadgeClass(sessionData).includes('green') ? ' opacity-75 border-2 border-green-500' : '') + ' rounded p-1 sm:p-2 text-xs cursor-pointer hover:opacity-90 transition-opacity flex flex-col'"
              class="relative">
              <!-- Indicador de completado -->
              @if (sessionData.SessionDetailData.completed && !isSessionCancelled(sessionData)) {
              <div
                class="absolute -top-1 -right-1 w-3 h-3 bg-green-500 rounded-full flex items-center justify-center z-10">
                <div class="w-1.5 h-1.5 bg-white rounded-full"></div>
              </div>
              }
              <!-- Botón para nueva sesión en cancelada (solo si no hay sesión activa en la fecha) -->
              @if (isSessionCancelled(sessionData) && !hasActiveSessionInDate(date)) {
              <button (click)="onNewSessionClickForDate(date); $event.stopPropagation()"
                class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-8 h-8 bg-green-500 hover:bg-green-600 rounded-full flex items-center justify-center z-20 transition-all duration-200 shadow-lg hover:shadow-xl hover:scale-110"
                title="Crear nueva sesión">
                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                </svg>
              </button>
              }
              <!-- Botón de recordatorio -->
              @if (canSendReminder(sessionData)) {
              <button (click)="onSendReminder(sessionData, $event)"
                class="absolute bottom-0.5 right-0.5 w-6 h-6 bg-[#0891b2] hover:bg-[#0891b2]/90 rounded-full flex items-center justify-center z-10 transition-colors shadow-lg"
                title="Enviar recordatorio por WhatsApp">
                <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
                </svg>
              </button>
              }
              <div class="flex flex-col space-y-0.5">
                <div [class]="isSessionCancelled(sessionData) ? 'truncate font-medium text-xs' : 'truncate font-medium text-xs text-white'">
                  {{ formatTime(sessionData.SessionDetailData.start_time) }} - {{ formatTime(sessionData.SessionDetailData.end_time) }}
                </div>
                <div [class]="isSessionCancelled(sessionData) ? 'truncate text-xs' : 'truncate text-xs text-white'">
                  <span class="sm:hidden">{{ getPatientNameFromSessionData(sessionData).split(' ')[0] }}</span>
                  <span class="hidden sm:inline">{{ getPatientNameFromSessionData(sessionData) }}</span>
                </div>
              </div>
            </div>
            }

            <!-- Botón "+" para crear nueva sesión cuando no hay sesiones -->
            @if (getSessionDataForDate(date).length === 0) {
            <button (click)="onNewSessionClickForDate(date)"
              class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-200 hover:bg-blue-50 rounded m-1"
              title="Crear nueva sesión">
              <svg class="w-6 h-6 text-gray-400 hover:text-blue-600 transition-colors" fill="none" stroke="currentColor"
                viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
              </svg>
            </button>
            }
          </div>
        </div>
        }
      </div>
      }
    </div>
  </div>
</div>

<!-- New Session Dialog -->
@if (showNewSessionDialog()) {
<app-new-session-dialog [prefilledData]="prefilledSessionData" (close)="onCloseNewSessionDialog()"
  (sessionDataCreated)="onSessionDataCreated($event)">
</app-new-session-dialog>
}

<!-- Reminder Confirmation Modal -->
@if (showReminderConfirmModal() && pendingReminderSession()) {
<div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
  <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 transform transition-all">
    <!-- Header -->
    <div class="px-6 py-4 border-b border-gray-200">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
          <svg class="w-5 h-5 text-blue-600" fill="currentColor" viewBox="0 0 24 24">
            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
          </svg>
        </div>
        <h3 class="text-lg font-semibold text-gray-900">Enviar Recordatorio</h3>
      </div>
    </div>

    <!-- Content -->
    <div class="px-6 py-4">
      <p class="text-gray-600 mb-4">
        ¿Estás seguro de que quieres enviar un recordatorio por WhatsApp?
      </p>

      <div class="bg-gray-50 rounded-lg p-4 space-y-2">
        <div class="flex justify-between">
          <span class="text-sm font-medium text-gray-500">Paciente:</span>
          <span class="text-sm text-gray-900">{{ getPatientNameFromSessionData(pendingReminderSession()!) }}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-sm font-medium text-gray-500">Fecha:</span>
          <span class="text-sm text-gray-900">{{ getFormattedSessionDate(pendingReminderSession()!) }}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-sm font-medium text-gray-500">Hora:</span>
          <span class="text-sm text-gray-900">{{ getFormattedSessionTime(pendingReminderSession()!) }}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-sm font-medium text-gray-500">Tipo:</span>
          <span class="text-sm text-gray-900">{{ pendingReminderSession()!.SessionDetailData.type }}</span>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="px-6 py-4 border-t border-gray-200 flex gap-3 justify-end">
      <button (click)="onCloseReminderConfirmModal()"
        class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
        Cancelar
      </button>
      <button (click)="onConfirmSendReminder()"
        class="bg-primary px-4 py-2 text-sm font-medium text-white rounded-md hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-opacity">
        Enviar Recordatorio
      </button>
    </div>
  </div>
</div>
}
