<div class="relative">
  <label
    for="clinic_search"
    class="text-sm font-semibold leading-none text-gray-700 peer-disabled:cursor-not-allowed peer-disabled:opacity-70 mb-2 block">
    {{ labelText }}
  </label>

  <div class="relative">
    <!-- Selected clinic display -->
    @if (selectedClinic()) {
      <div
        class="flex h-10 w-full rounded-md border border-gray-300 bg-gray-50 px-3 py-2 text-sm text-gray-900 items-center justify-between hover:border-gray-400 focus-within:outline-none focus-within:ring-2 focus-within:ring-[#0891b2] focus-within:bg-white focus-within:border-[#0891b2] transition-colors"
        [class.border-red-500]="hasError"
        [class.focus-within:ring-red-500]="hasError"
        [class.focus-within:border-red-500]="hasError"
        (click)="openDropdown()"
        tabindex="0"
        role="button"
        [attr.aria-label]="'Clínica seleccionada: ' + selectedClinic()?.name + '. Presiona Enter para cambiar.'"
        [attr.aria-expanded]="isDropdownOpenValue"
        [attr.aria-haspopup]="true">

        <div class="flex items-center gap-2 flex-1">
          <!-- Clinic color indicator -->
          <div
            class="w-3 h-3 rounded-full flex-shrink-0"
            [style.background-color]="selectedClinic()?.clinic_color"
            [attr.aria-label]="'Color de clínica: ' + selectedClinic()?.clinic_color">
          </div>
          <span class="truncate">{{ selectedClinic()?.name }}</span>
        </div>

        <!-- Clear button -->
        <button
          type="button"
          class="flex-shrink-0 p-1 hover:bg-gray-200 rounded-full transition-colors"
          (click)="$event.stopPropagation(); clearSelection()"
          title="Limpiar selección"
          aria-label="Limpiar selección de clínica">
          <svg class="h-4 w-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
    } @else {
      <!-- Search input -->
      <input
        #searchInput
        id="clinic_search"
        type="text"
        [value]="searchTermValue"
        (input)="onSearchInput($event)"
        (focus)="onInputFocus()"
        (blur)="onInputBlur()"
        class="flex h-10 w-full rounded-md border border-gray-300 bg-gray-50 px-3 py-2 pr-10 text-sm text-gray-900 placeholder:text-gray-500 hover:border-gray-400 focus:outline-none focus:ring-2 focus:ring-[#0891b2] focus:bg-white focus:border-[#0891b2] disabled:cursor-not-allowed disabled:opacity-50 transition-colors"
        [class.border-red-500]="hasError"
        [class.focus:ring-red-500]="hasError"
        [class.focus:border-red-500]="hasError"
        [placeholder]="placeholder"
        [attr.aria-label]="labelText"
        [attr.aria-expanded]="isDropdownOpenValue"
        [attr.aria-haspopup]="true"
        [attr.aria-describedby]="hasError ? 'clinic-error' : null"
        autocomplete="off"
        role="combobox">

      <!-- Search icon -->
      <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
        <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
      </div>
    }

    <!-- Dropdown -->
    @if (isDropdownOpenValue && filteredClinics().length > 0 && !selectedClinic()) {
      <div
        class="absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-auto"
        role="listbox"
        [attr.aria-label]="'Lista de clínicas disponibles'">
        @for (clinic of filteredClinics(); track clinic.id; let i = $index) {
          <button
            type="button"
            class="w-full px-3 py-2 text-left text-sm hover:bg-gray-100 focus:bg-gray-100 focus:outline-none flex items-center gap-2"
            [class.bg-blue-50]="isClinicSelected(clinic)"
            [class.bg-gray-100]="focusedIndexValue === i"
            (click)="selectClinic(clinic)"
            (mouseenter)="focusedIndex.set(i)"
            [attr.aria-selected]="isClinicSelected(clinic)"
            [attr.aria-label]="'Seleccionar clínica: ' + clinic.name"
            role="option">

            <!-- Clinic color indicator -->
            <div
              class="w-3 h-3 rounded-full flex-shrink-0"
              [style.background-color]="clinic.clinic_color"
              [attr.aria-label]="'Color: ' + clinic.clinic_color">
            </div>
            <span class="truncate">{{ clinic.name }}</span>

            @if (isClinicSelected(clinic)) {
              <svg class="ml-auto h-4 w-4 text-blue-600" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
              </svg>
            }
          </button>
        }
      </div>
    }

    <!-- No results message -->
    @if (isDropdownOpenValue && filteredClinics().length === 0 && searchTermValue && !selectedClinic()) {
      <div
        class="absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg"
        role="status"
        aria-live="polite">
        <div class="px-3 py-2 text-sm text-gray-500">
          No se encontraron clínicas
        </div>
      </div>
    }
  </div>

  <!-- Error message -->
  @if (hasError) {
    <p
      id="clinic-error"
      class="text-red-500 text-xs mt-1"
      role="alert"
      aria-live="polite">
      {{ errorMessage }}
    </p>
  }
</div>